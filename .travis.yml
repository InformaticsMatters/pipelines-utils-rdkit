---

# The pipelines-utils-rdkit Travis CI/CD configuration.
# Here we concentrate on the src/python part of the repository.
# where we run coverage testing and then deploy when tagged.
#
# We avoid running pylint at the moment because the vast majority of the
# code is legacy and fails a number of best-practice tests.

language: python

os:
- linux

# Our build stages.
# (`test` is basically a travis default default so we don't need to name it).
# But we do want a `deploy` stage that only runs if the the commit is tagged
stages:
- name: test
  if: not tag is present
- name: deploy
  if: tag is present

# Run Travis on all branches
# (normally it only runs on master)
branches:
  only:
  - "/.*/"

# Installation steps.
# We have more than one requirements file and need to install
# a mock version of dependent packages in order to run our tests.
install:
- pip install -r package-requirements.txt
- cd ${TRAVIS_BUILD_DIR}/mock-rdkit
- python setup.py install

# Test/build execution steps...
# All in the default 'test' stage.
script:
- export TRAVIS_TAG="${TRAVIS_TAG:-1.0.0}"
- echo "${TRAVIS_TAG}"
- cd ${TRAVIS_BUILD_DIR}/src/python
- python setup.py bdist_wheel

# Execution jobs.
# Let's run the script against various Python versions
# and then move to our deploy stage. Travis will only run the deploy stage
# when the test stages have passed. Deployment will also only execute
# if this triggering commit is tagged and we're on the master branch.
jobs:
  include:
  - python: 2.7
  - python: 3.5
  - python: 3.6
  - python: 3.7
  - python: 3.8

  - stage: deploy
    python: 3.8
    # No need to re-run scripted commands here.
    # They're all part of the above test stages.
    script: skip
    # Our module and setup.py is not located in the root of the project.
    # Move to it before we deploy.
    before_deploy:
    - cd ${TRAVIS_BUILD_DIR}/src/python
    deploy:
      provider: pypi
      user: informaticsmatters
      password:
        secure: "WfnusbdpuGVQ1YGpZ1uPKXrp7/yl5IJj/l38pH74DbicKbLze+weAYmR/TCm5lOOgtuOVOdZu300NIU5bmrSMWL6QXAX6hNA3COJERmDKrjNBwvLHsOK/0zq5T3CEYUUuFwrngshZfDyoL6JW0gGyjV/Ep7D/gO5J00/L2B1YtGTxOanOiwcwuSMikrs7zIc+PBuRHw4Zzs7+GuBsVFIvnhwMhADiE/Tc9NLx/iRNtcS5OWRXcvh4eKOguxgmDH1Y/gNH6dwbWYYSsSdT5kq/ViA8zKMquHSyhYPHBnvSA+lH2L4pEhOGipxwlU5xhLWI9Tpp627wDzTsde5CwuXzErs3CRQhTB18ZKwWkXyHAuuijvNctKP8jGh12/bO2CJRH6jCXU1gLpJJ9NT+m7un7yeKI7CRVIoMR5+Kk+gMIJNqL5uAUxkMcBhfogDrPKja8zH+9xymY2TJ25VG5TP7nT2rctVUuQ57VSDpCQa2uqNwDw94kb6zGfJhtBySOgJOdJ72xVt9Oc6GcKFEi87wgdt/AZt/b5zcsyiVSjqwuACax4Anr3moDc6bvpRmo62Wnat33C+9jjQfuvpQW3DjfTtrvlGA7OsHLgEgC6Q0EZwGKg3bsNwzIPdkLQ5ZJtm31o7726+oLXnCWeAPZzZgYkYkT8JjGZns726s+/4xps="
      distributions: bdist_wheel
      on:
        tags: true
